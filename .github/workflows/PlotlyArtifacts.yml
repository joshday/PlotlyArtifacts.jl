name: Plotly Artifacts

on:
  schedule:
    # Run once daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  publish-artifact:
    runs-on: ubuntu-latest
    steps:
      - name: Download latest Plotly.js
        id: download
        run: |
          # Get latest release tag
          RESPONSE=$(curl -s https://api.github.com/repos/plotly/plotly.js/releases/latest)
          VERSION=$(echo $RESPONSE | jq -r '.tag_name')
          DOWNLOAD_URL="https://github.com/plotly/plotly.js/raw/$VERSION/dist/plotly.min.js"

          # Download the file
          curl -L -o plotly.min.js "$DOWNLOAD_URL"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Downloaded Plotly version: $VERSION"
          tar -czf plotly.min.js-${VERSION}.tar.gz plotly.min.js
          echo "Created plotly.min.js-${VERSION}.tar.gz"


      - name: Download latest Plotly schema
        run: |
          VERSION="${{ steps.download.outputs.version }}"
          SCHEMA_URL="https://github.com/plotly/plotly.js/raw/$VERSION/dist/plot-schema.json"

          curl -L -o plot-schema.json "$SCHEMA_URL"
          echo "Downloaded Plotly schema for version: $VERSION"
          tar -czf plot-schema.json-${VERSION}.tar.gz plot-schema.json
          echo "Created plot-schema.json-${VERSION}.tar.gz"


      - name: Download Plotly Python templates
        id: templates
        run: |
          # Get latest release tag
          RESPONSE=$(curl -s https://api.github.com/repos/plotly/plotly.py/releases/latest)
          VERSION=$(echo $RESPONSE | jq -r '.tag_name')

          mkdir -p templates

          TEMPLATES=("ggplot2" "gridon" "plotly" "plotly_dark" "plotly_white" "presentation" "seaborn" "simple_white" "xgridoff" "ygridoff")

          for template in "${TEMPLATES[@]}"; do
            TEMPLATE_URL="https://github.com/plotly/plotly.py/raw/$VERSION/plotly/package_data/templates/${template}.json"
            curl -L -o "templates/${template}.json" "$TEMPLATE_URL"
            echo "Downloaded template: $template"
          done

          echo "Downloaded all Plotly Python templates"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          tar -czf templates-${VERSION}.tar.gz templates/
          echo "Created templates-${VERSION}.tar.gz"

      - name: Upload artifacts to Artifacts release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get or create the "Artifacts" release
          RELEASE=$(gh release list --repo ${{ github.repository }} --json name | jq -r '.[] | select(.name == "Artifacts") | .name')

          if [ -z "$RELEASE" ]; then
            # Create the release if it doesn't exist
            gh release create Artifacts --repo ${{ github.repository }} --title "Artifacts" --notes "Plotly artifacts for Julia"
          fi

          PLOTLY_JS_VERSION="${{ steps.download.outputs.version }}"
          TEMPLATES_VERSION="${{ steps.templates.outputs.version }}"

          # Upload the tar.gz files
          gh release upload Artifacts plotly.min.js-${PLOTLY_JS_VERSION}.tar.gz --repo ${{ github.repository }}
          gh release upload Artifacts plot-schema.json-${PLOTLY_JS_VERSION}.tar.gz --repo ${{ github.repository }}
          gh release upload Artifacts templates-${TEMPLATES_VERSION}.tar.gz --repo ${{ github.repository }}

          echo "Uploaded all artifacts to Artifacts release"
